<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <script>
        $( function() {
            $( document ).tooltip();
        } );
    </script>
    <script>
        String.prototype.sliceReplace = function(start, end, repl) {
            return this.substring(0, start) + repl + this.substring(end);
        };
    </script>
    <script>
        run_antlr = async function() {
            var g = $('#grammar').val();
            var lg = $('#lexgrammar').val();
            var I = $('#input').text();
            var s = $('#start').val();
            // console.log(I)
            // console.log(s)

            const res = await axios.post("http://localhost:8080/antlr/",
                null, // null data
                { params: { grammar: g, lexgrammar: lg, input: I, start:s } })
                .then(function (response) {
                    // handle success
                    console.log(response.data.result);

                    // $("#t1").tooltip( "option", "content", "Awesome title!" );

                    if ( response.data.parser_grammar_errors.length>0 ||
                        response.data.lexer_grammar_errors.length>0 ||
                        response.data.warnings.length>0 ) {
                        $("#console").text(
                            JSON.stringify(response.data.parser_grammar_errors) + "\n" +
                            JSON.stringify(response.data.lexer_grammar_errors) + "\n" +
                            JSON.stringify(response.data.warnings)
                        );
                    }
                    else {
                        $("#console").text("");
                    }
                    let tokens = response.data.result.tokens;
                    let symbols = response.data.result.symbols;
                    let last = -1;
                    let newInput = "";
                    for (ti in tokens) {
                        let t = tokens[ti];
                        let toktext = I.slice(t.start,t.stop+1);
                        console.log(t);
                        console.log(toktext);
                        if ( t.start != last+1 ) {
                            let skippedText = I.slice(last+1,t.start);
                            console.log("missing token '"+ skippedText+"'");
                            newInput += skippedText;
                        }
                        newInput += "<span title='"+symbols[t.type]+"'>"+toktext+"</span>"
                        last = t.stop;
                        // newInput = newInput.sliceReplace(t.start,t.stop+1, "<span title='foo'>"+toktext+"</span>");
                        // newInput += "<span title='foo'>"+toktext+"</span>";
                    }
                    console.log(newInput);
                    // $("#input").text(newInput);
                    $("#input").html(newInput);

                    $(function () {
                            $('div span').hover(
                                function () {
                                    $(this)
                                        .css('text-decoration', 'underline')
                                        .css('text-decoration-color', 'darkgray').text();
                                },
                                function() { $(this).css('text-decoration',''); }
                            );
                        }
                    );

                })
        }
    </script>
</head>
<body>

    <P>
<TEXTAREA name="grammar" id="grammar" rows="10" cols="40">
parser grammar ExprParser;
options { tokenVocab=ExprLexer; }

program
    : stat EOF
    | def EOF
    ;

stat: ID '=' expr ';'
    | expr ';'
    ;

def : ID '(' ID (',' ID)* ')' '{' stat* '}' ;

expr: ID
    | INT
    | func
    | 'not' expr
    | expr 'and' expr
    | expr 'or' expr
    ;

func : ID '(' expr (',' expr)* ')' ;
</TEXTAREA>

<TEXTAREA name="lexgrammar" id="lexgrammar" rows="10" cols="40">
lexer grammar ExprLexer;

AND : 'and' ;
OR : 'or' ;
NOT : 'not' ;
EQ : '=' ;
COMMA : ',' ;
SEMI : ';' ;
LPAREN : '(' ;
RPAREN : ')' ;
LCURLY : '{' ;
RCURLY : '}' ;

INT : [0-9]+ ;
ID: [a-zA-Z_][a-zA-Z_0-9]* ;
WS: [ \t\n\r\f]+ -> skip ;
</TEXTAREA>
            </P>
<p>
<!--    <div id="input" contenteditable="true" style="border:1px solid darkgray"><span id="t1" title="oooooo">foo(able, y, z)</span> { x = x and y or z; g(30); }</div>-->
    <div id="input" contenteditable="true" style="border:1px solid darkgray">foo(able, y, z) { x = x and y or z; g(30); }</div>
</p>
    <INPUT type="text" id="start" name="start" value="program">
    <br>
    <br>
    <button type="button" onclick="run_antlr()">RUN</button>

<br>
<br>
    <div id="console"></div> <!-- tool errors -->
</body>
</html>

